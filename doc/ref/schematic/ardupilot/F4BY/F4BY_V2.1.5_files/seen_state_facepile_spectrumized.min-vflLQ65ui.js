define(["require","exports","tslib","external/classnames","react","external/prop-types","external/lodash","deep-integrations/data/user_settings","modules/clean/components/loading_indicator","modules/clean/file_store/utils","modules/clean/loggers/pass_facepile_logger","modules/clean/integrations/data/store","modules/clean/react/css","modules/clean/react/file_viewer/share_helpers","modules/clean/react/pass/avatars","modules/clean/react/pass/constants","modules/clean/react/pass/event_emitter","modules/clean/react/pass/empty_seen_state_facepile","modules/clean/react/pass/utils","modules/clean/react/pass/types","modules/clean/react/size_class/constants","modules/clean/sharing/constants","modules/clean/viewer","modules/core/i18n","modules/core/user_i18n","comments2/components/rich_facepile","spectrum/facepile"],function(e,t,s,n,r,o,i,a,p,u,l,c,d,f,h,m,_,g,S,v,y,I,w,C,E,L,P){"use strict";function A(e){var t=e.userId,s=e.displayName;return t&&S.AnonymousViewerUtils.isAnonymousUserId(t)?{colorSeed:t,initials:S.AnonymousViewerUtils.getAnonymousViewerInitials(s)}:{colorSeed:s,initials:E.getInitials(s)}}Object.defineProperty(t,"__esModule",{value:!0}),n=s.__importDefault(n),r=s.__importDefault(r),o=s.__importStar(o),i=s.__importStar(i),f=s.__importStar(f),E=s.__importStar(E);var T=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state={newPresentUserIds:[]},t.hasPassShownBeenLogged=!1,t.onAvatarHover=function(){return t.logPassEvent(m.EventTypes.PASS_HOVER)},t.openShareModal=function(){var e=t.props.fromBrowse?I.SHARE_ACTION_ORIGIN_TYPE.BROWSE_FILE_FACEPILE:I.SHARE_ACTION_ORIGIN_TYPE.PREVIEW_PAGE_FACEPILE;f.share(t.props.file,w.Viewer.get_viewer().get_user_by_id(t.props.user.id),t.props.url||null,e)},t.onAvatarClick=function(e){t.logPassEvent(m.EventTypes.PASS_CLICK);var s=t.context.getIntegrationStore(),n=t.getPromptsToDismiss(s);n.length>0&&c.wrapDispatch(s.dispatch)(a.dismissPrompts(n)),e===L.OVERFLOW&&t.openShareModal()},t.onTooltipChange=function(e,s){var n=(e.activeMode,e.displayInfo),r=(s.activeMode,s.displayInfo);null!==r&&n!==r&&t.onAvatarHover()},t.localization={nOthers:function(e,t){return C.ungettext("%(display_num)s other","%(display_num)s others",e).format({display_num:t})},ninetyNinePlus:C._("99+")},t}return s.__extends(t,e),t.prototype.componentWillMount=function(){this.resetLogging(),l.passFacepileLogger.listenTo(_.passEventEmitter)},t.prototype.componentDidMount=function(){this.logFacepileShownEvents()},t.prototype.componentWillReceiveProps=function(e){if(u.areFilesEqual(this.props.file,e.file)){if(null==e.presence||null==this.props.presence)return;var t=i.difference(e.presence,this.props.presence),s=i.difference(this.props.presence,e.presence);this.updateNewPresentUserIds(t,s)}else this.setState({newPresentUserIds:[]}),this.resetLogging()},t.prototype.componentDidUpdate=function(e){this.logFacepileShownEvents()},t.prototype.componentWillUnmount=function(){l.passFacepileLogger.unlistenTo(_.passEventEmitter)},t.prototype.updateNewPresentUserIds=function(e,t){var s=i.filter(this.state.newPresentUserIds,function(e){return t.indexOf(e)===-1});this.setState({newPresentUserIds:e.concat(s)})},t.prototype.computeOverflowBasis=function(e){if(!this.props.uniqueMemberCountInfo.data)return e.length;var t=this.props.uniqueMemberCountInfo.data;return e.forEach(function(e){e.incrementOverflowBasis&&++t}),Math.max(t,e.length)},t.prototype.resetLogging=function(){this.hasPassShownBeenLogged=!1},t.prototype.logFacepileShownEvents=function(){if(!this.hasPassShownBeenLogged&&this.dataSufficientForLoggingHasLoaded()){var e=this.getUserInfoList();this.haveSeenStateDataToShow(e)&&(this.logPassEvent(m.EventTypes.PASS_SHOWN,e),this.hasPassShownBeenLogged=!0)}},t.prototype.logPassEvent=function(e,t){var s=this.props,n=s.anonymousPresenceInfo.length,r=s.fromBrowse,o=s.file,i=s.passPermissions,a=this.getViewerCountByAccessLevel(),p=a.numViewers,u=a.numInTeamEditors,l=a.numInTeamViewers,c=a.numNonTeamEditors,d=a.numNonTeamViewers,f=this.computeOverflowBasis(t||this.getUserInfoList());return _.passEventEmitter.emit(e,r,o,{numAccessors:f,numViewers:p,numCurrentViewers:this.getNumCurrentViewers(),canSeeViewerHistory:i&&i.canReadSeenState,numGuests:n,numInTeamEditors:u,numInTeamViewers:l,numNonTeamEditors:c,numNonTeamViewers:d})},t.prototype.getViewerCountByAccessLevel=function(){var e,t,s=this,n=0,r=0,o=0,i=0;if(this.shouldHardcodeCurrentViewer()){t=this.seenStateDataWithViewerFiltered(this.getSeenStates());var a=this.getSeenStates().filter(function(e){return e.seen_state_user.user_id===s.props.user.account_id});if(a.length>0){e=0;var p=a[0];p.when_last_seen=1,t.push(p)}else e=1,n++}else e=0,t=this.getSeenStates();for(var u=0,l=t;u<l.length;u++){var c=l[u];if(null!=c.when_last_seen){e++;var d=c.seen_state_user;d.in_owners_team?d.sharing_access_type&&"edit_member_access"===d.sharing_access_type.type?n++:r++:d.sharing_access_type&&"edit_member_access"===d.sharing_access_type.type?o++:i++}}return{numViewers:e,numInTeamEditors:n,numInTeamViewers:r,numNonTeamEditors:o,numNonTeamViewers:i}},t.prototype.getNumCurrentViewers=function(){var e=this;if(!this.props.presence)return 0;if(this.shouldHardcodeCurrentViewer()){return 1+this.props.presence.filter(function(t){return t!==e.props.user.account_id}).map(function(e){return e}).length}return this.props.presence.length},t.prototype.userIsAnonymous=function(e){return i.map(this.props.anonymousPresenceInfo,function(e){return e.seen_state_user.user_id}).indexOf(e.user_id)>=0},t.prototype.userIsOnline=function(e){return null!=this.props.presence&&this.props.presence.indexOf(e.user_id)>=0},t.prototype.buildUserInfo=function(e){var t=e.platform_type,s=e.seen_state_user,n=e.seen_state_user,r=n.access_level,o=n.display_name,i=n.email,a=n.photo_circle_url,p=n.sharing_access_type,u=n.user_id,l=e.when_last_seen,c=u||o,d=S.shouldIncrementOverflowBasisForAccessType(p);return new v.UserInfo(c,o,this.userIsOnline(s),!1,d,i,r,l,a,u,t)},t.prototype.seenStateDataWithViewerFiltered=function(e){var t=this;return i.filter(e,function(e){return e.seen_state_user.user_id!==t.props.user.account_id})},t.prototype.partitionUserInfoLists=function(e){for(var t=[],s=[],n=[],r=[],o=[],i={},a=0,p=e;a<p.length;a++){var u=p[a],l=this.buildUserInfo(u);this.userIsOnline(u.seen_state_user)?this.isNewPresentUser(l)?i[l.key]=l:this.userIsAnonymous(u.seen_state_user)?n.push(l):s.push(l):null!=u.when_last_seen?r.push(l):o.push(l)}for(var c=0,d=this.state.newPresentUserIds;c<d.length;c++){var f=d[c],l=i[f];l&&t.push(l)}return{newPresentUserInfoList:t,presentUserInfoList:s,anonymousUserInfoList:n,offlineUserInfoList:r,neverViewedUserInfoList:o}},t.prototype.getUserInfoList=function(){var e,t=[],s=this.getMergedSeenStateData();if(this.shouldHardcodeCurrentViewer()){e=this.seenStateDataWithViewerFiltered(s);var n=this.props.user.account_id,r=!this.props.fromBrowse&&e.length<s.length&&this.getSeenStates().some(function(e){var t=e.seen_state_user;return t.user_id===n&&S.shouldIncrementOverflowBasisForAccessType(t.sharing_access_type)}),o=w.Viewer.get_viewer().get_user_by_id(this.props.user.id);t.push(new v.UserInfo(this.props.user.account_id,o.display_name,!0,!0,r,o.email,void 0,void 0,o.photo_url))}else e=s;var i=this.partitionUserInfoLists(e),a=i.newPresentUserInfoList,p=i.presentUserInfoList,u=i.anonymousUserInfoList,l=i.offlineUserInfoList,c=i.neverViewedUserInfoList;return p.sort(function(e,t){return e.displayName.toLowerCase().localeCompare(t.displayName.toLowerCase())}),c.sort(function(e,t){return e.displayName.toLowerCase().localeCompare(t.displayName.toLowerCase())}),t.concat(a,p,u,l,c)},t.prototype.isNewPresentUser=function(e){return this.state.newPresentUserIds.indexOf(e.key)>=0},t.prototype.getMergedSeenStateData=function(){var e=this.getSeenStates(),t=e.map(function(e){return e.seen_state_user.user_id});if(this.props.sharingStorePassInfo.data){for(var s=0,n=this.props.sharingStorePassInfo.data.users;s<n.length;s++){var r=n[s],o=r.seen_state_user.user_id;t.indexOf(o)!==-1||o===this.props.user.account_id&&this.shouldHardcodeCurrentViewer()||e.push(r)}return e.concat(this.props.anonymousPresenceInfo,this.props.sharingStorePassInfo.data.invitees)}return e.concat(this.props.anonymousPresenceInfo)},t.prototype.shouldHardcodeCurrentViewer=function(){var e=!(w.Viewer.get_viewer().is_assume_user_session||this.props.fromBrowse),t=null!=this.props.presence&&this.props.presence.indexOf(this.props.user.account_id)>=0;return e||t},t.prototype.getSeenStates=function(){return this.props.identifiedSeenStateInfo&&this.props.identifiedSeenStateInfo.seen_states?this.props.identifiedSeenStateInfo.seen_states.slice():[]},t.prototype.haveSeenStateDataToShow=function(e){var t=e.length;return t>=2||1===t&&e[0].key!==this.props.user.account_id},t.prototype.dataSufficientForLoggingHasLoaded=function(){return this.sharingAndCountInfoHasLoaded()&&m.fetchingStatusCanLogAsShown(this.props.passFetchingStatus)},t.prototype.dataSufficientForDisplayHasLoaded=function(){return this.sharingAndCountInfoHasLoaded()&&m.fetchingStatusSeenStateIsComplete(this.props.passFetchingStatus)},t.prototype.sharingAndCountInfoHasLoaded=function(){var e=this.props,t=e.sharingStorePassInfo,s=e.uniqueMemberCountInfo;return t.isLoaded&&s.isLoaded},t.prototype.getPromptsToDismiss=function(e){return[{".tag":"tooltip_click_for_more"},{".tag":"tooltip_click_for_more_auto_display"}].filter(function(t){return!c.isPromptDismissed(e.getState(),t[".tag"])})},t.prototype.render=function(){var e,t=this.props,s=t.fromBrowse,n=t.isCollapsed,o=t.isPassPermissionsPending,i=t.passFetchingStatus,a=t.passPermissions;if(o||i===m.PassFetchingStatus.ERROR||null==a||!a.canReadPresence&&!a.canReadSeenState)return this.renderEmptyFacepile();if(!this.dataSufficientForDisplayHasLoaded())return s?r.default.createElement(p.LoadingIndicator,{style:p.LoadingIndicator.LoadingIndicatorStyle.DOTS}):r.default.createElement("div",null);var u=this.getUserInfoList();if(this.haveSeenStateDataToShow(u)){if(n)return this.renderCollapsedFacepile(u[0]);var l=this.computeOverflowBasis(u);return r.default.createElement("div",{className:this.facepileClassName()},r.default.createElement(L.RichFacepile,{avatarInfoList:this.computeAvatarInfos(u),becomePassiveOnOverflowAvatarClick:!0,localization:this.localization,onAvatarClick:this.onAvatarClick,onTooltipChange:this.onTooltipChange,overflowBasis:l,sizeClass:this.getConvertedSizeClass(),sizeClassToCircleCountOverrides:(e={},e[L.SizeClass.Small]=0,e[L.SizeClass.Large]=3,e),tooltipComponent:L.UtilTooltip}))}return this.renderEmptyFacepile()},t.prototype.getConvertedSizeClass=function(){switch(this.props.sizeClass){case y.SizeClass.Small:return L.SizeClass.Small;case y.SizeClass.Medium:return L.SizeClass.Medium;case y.SizeClass.Large:return L.SizeClass.Large;case y.SizeClass.ExtraLarge:return L.SizeClass.ExtraLarge}},t.prototype.renderEmptyFacepile=function(){return r.default.createElement(g.EmptySeenStateFacepile,{hasPresence:null!=this.props.presence})},t.prototype.renderCollapsedFacepile=function(e){var t=e.isActive,s=e.displayName,n=e.photoUrl;return r.default.createElement(P.FacepileMembersAvatar,{active:t,avatarColorSeed:s,avatarSize:32,initials:E.getInitials(s),photoUrl:n||null,disabled:!0})},t.prototype.facepileClassName=function(){var e;return n.default((e={},e[m.FACEPILE_CLASSNAME]=!0,e[m.PRESENCE_RECEIVED_CLASSNAME]=null!=this.props.presence,e))},t.prototype.computeAvatarInfos=function(e){if(0===e.length)return[];var t=this.context.getIntegrationStore(),s=this.context.logEvent(),n=this.context.performanceTimer(),o=this.context.reportError(),i=this.props,a=i.file,p=i.file.file_id,l=i.user.id,c=u.getFilename(a);return e.slice(0,L.MAX_FACES).map(function(e){var i=A(e),a=i.colorSeed,u=i.initials,d=e.isActive,f=e.displayName,m=e.key,_=e.userId;return{present:d,displayName:f,avatarColorSeed:a,initials:u,memberKey:m,photoUrl:e.photoUrl||null,userId:_,passiveTooltipContent:r.default.createElement(h.UserAvatarPassiveTooltipContent,{colorSeed:a,integrationStore:t,userInfo:e}),activeTooltipContent:r.default.createElement(h.UserAvatarActiveTooltipContent,{colorSeed:a,integrationStore:t,integrationInfo:{fileId:p,fileName:c,userId:l},logEvent:s,performanceTimer:n,reportError:o,userInfo:e})}})},t.contextTypes={getIntegrationStore:o.func,logEvent:o.func,performanceTimer:o.func,reportError:o.func},t})(r.default.Component);t.SeenStateFacepileComponentSpectrumized=T,t.SeenStateFacepileSpectrumized=d.requireCssWithComponent(T,["/static/css/seen_state_facepile-vflE5WDhj.css","/static/js/deep-integrations/index.web-vflltJo56.css","/static/js/comments2/index.web-vflARkr3t.css"])});
//# sourceMappingURL=seen_state_facepile_spectrumized.min.js-vflqMqJ6H.map